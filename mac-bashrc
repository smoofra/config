# -*- mode: shell-script -*-

[[ -e ~/bin/addpath ]] && PATH=$(~/bin/addpath "$HOME/bin.local" "$HOME/bin" "$HOME/apple_config/bin" /usr/local/bin /usr/local/sbin "$PATH" )

if which gls >/dev/null ; then
	alias ls='gls --color=auto'
elif ls --version 2>/dev/null | grep -iq gnu ; then
	alias ls='ls --color=auto'
fi

if which grm >/dev/null ; then
	alias rm=grm
fi

if which gfind >/dev/null ; then
    alias find=gfind
fi

if which gxargs >/dev/null ; then
    alias xargs=gxargs
fi

export EDITOR=vim

if [[ ! -z "$INSIDE_EMACS" ]] ; then
    export TERM=vt100
    export EDITOR=emacsclient
fi

function trim_pwd() {
    local pwd
    local len
    local expr
    local limit
    limit=40

    expr=expr
    if [ ! x$($expr length "FOO" 2>/dev/null) = "x3" ]; then
        expr=gexpr
        if [ ! x$($expr length "FOO" 2>/dev/null) = "x3" ]; then
            pwd
            return
        fi
    fi

    pwd="$(pwd)"
    len=$($expr length "$pwd")


    if [ "$($expr substr "$pwd" 1 $($expr length "$HOME"))" = "$HOME" ]; then
        pwd="~$($expr substr "$pwd" $($expr 1 + $($expr length "$HOME")) $len)"
        len=$($expr length "$pwd")
    fi

    if [ $len -gt $limit ]; then
        pwd=..."$($expr substr "$pwd" $($expr $len - $limit) $len)"
    fi
    echo "$pwd"
}

#export PS1='\u@\h:\w\$ '
export PS1='\u@\h:$(trim_pwd)\$ '

if echo "$PATH" | tr : \\n | grep -q ~/x-tools ; then
    export PS1="-XT- $PS1"
fi

alias rerc='. ~/.bashrc'

PERL_MB_OPT="--install_base \"/Users/lawrence_danna/perl5\""; export PERL_MB_OPT;
PERL_MM_OPT="INSTALL_BASE=/Users/lawrence_danna/perl5"; export PERL_MM_OPT;

function xt() {
    (
        PATH=$(~/bin/addpath ~/x-tools/*/bin "$PATH")
        export HOST_CPPFLAGS=""
        export HOST_LDFLAGS=""
        HOST_CPPFLAGS+=" -I/usr/local/opt/gettext/include "
        HOST_LDFLAGS+=" -L/usr/local/opt/gettext/lib "
        HOST_CPPFLAGS+=" -I/usr/local/opt/openssl/include "
        HOST_LDFLAGS+=" -L/usr/local/opt/openssl/lib "
        "$@"
    )
}

function link-x-tools() {
    (
        trap 'echo FAILED' EXIT

        set -e
        mkdir -p ~/x-tools/host/bin

        tools=$(cat <<EOF
[ base64 basename cat chcon chgrp chmod chown chroot cksum comm cp csplit cut
date dd df dir dircolors dirname du echo env expand expr factor false fmt fold
grep groups head hostid id install join kill link ln logname ls md5sum mkdir
mkfifo mknod mktemp mv nice nl nohup nproc numfmt od paste pathchk pinky pr
printenv printf ptx pwd readlink realpath rm rmdir runcon seq sha1sum sha224sum
sha256sum sha384sum sha512sum shred shuf sleep sort split stat stdbuf stty sum
sync tac tail tee test timeout touch tr true truncate tsort tty uname unexpand
uniq unlink uptime users vdir wc who whoami xargs yes
EOF
             )
        for x in $tools ; do
            which "g$x" >/dev/null
            ln -sf `which g$x` ~/x-tools/host/bin/$x
        done

        [ -e /usr/local/opt/gnu-getopt/bin/getopt ] || exit
        ln -sf /usr/local/opt/gnu-getopt/bin/getopt ~/x-tools/host/bin/getopt
        ln -sf /usr/local/opt/gnu-getopt/bin/getopt ~/x-tools/host/bin/gnugetopt

        [ -e /usr/local/opt/gnu-sed/bin/gsed ] || exit
        ln -sf /usr/local/opt/gnu-sed/bin/gsed  ~/x-tools/host/bin/sed

        [ -e /usr/local/opt/make/bin/make ] || exit
        ln -sf /usr/local/opt/make/bin/make ~/x-tools/host/bin/make

        ln -sf $(ls -d  /usr/local/Cellar/gettext/* | sort | tail -1 )/bin/xgettext ~/x-tools/host/bin/xgettext

        trap 0 EXIT
    )
}

function foo() {
    (
        set -e
        false
        echo foo
    )
}

function slap() {
    phone=titan
    xcodebuild -sdk iphoneos.internal -target $1 install DSTROOT=root && \
        tar -C root/ -zcf root.tgz . && \
        sshcatkey $phone && scp root.tgz $phone: && \
        ssh $phone darwinup install root.tgz
}

function darwinup-sdk() {
    darwinup -p $(xcrun -show-sdk-path -sdk iphoneos.internal) $@
}

export HOMEBREW_CASK_OPTS="--appdir=/Applications"

# mouse on / mouse off
alias mouse='tmux setw -g mode-mouse'

alias ffi='~rc/bin/findFiles -release Monarch'

alias ffx='~rc/bin/findFiles -release Gala'

alias resetup='sh ~/config/setup-mac.sh'

alias bear='bear -a'

alias rerdm='launchctl unload  ~/Library/LaunchAgents/com.andersbakken.rtags.agent.plist ; launchctl load  ~/Library/LaunchAgents/com.andersbakken.rtags.agent.plist'
